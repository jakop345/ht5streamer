//load modules
var ytdl = require('ytdl');
var youtube = require('youtube-feeds');
var http = require('http');
var https = require('https');

// module vars
var current_search_page=1;
var current_start_index = 1;
var videos_responses = new Array();
var yt = {};


// search videos
yt.searchVideos = function (user_search, page, filters, order, cb){
    videos_responses = new Array();
    if (page === 1){
        current_start_index = 1;
    } else {
        current_start_index = (page - 1) * 25 + 1;    
    }
    var params = {};
    if (filters === '') {
        params = {
                    'q':              ''+user_search+'',
                    'start-index' : ''+current_start_index+'',
                    'max-results':  25,
                    'orderby':        ''+order+'',
                }
    } else if (filters === 'hd') {
        params = {
                    'q':              ''+user_search+'',
                    'start-index' : ''+current_start_index+'',
                    'max-results':  25,
                    'orderby':        ''+order+'',
                    'hd' : true
                }
    } else if (filters === '3d') {
        params = {
                    'q':              ''+user_search+'',
                    'start-index' : ''+current_start_index+'',
                    'max-results':  25,
                    'orderby':        ''+order+'',
                    '3d' : true
                }
    }
    try{
        youtube.feeds.videos(params,
            function( err, data ) {
            if( err ) {
                cb(err);
            } else {
                cb(data);
            }
        });
    }catch(err){
        console.log('searchVideos err: '+err);
    }
}

// search related videos
yt.searchRelated = function (vid, page, filters, cb){
    videos_responses = new Array();
    if (page === 1){
        current_start_index = 1;
    } else {
        current_start_index = (page - 1) * 10 + 1;    
    }
    var params = {};
    if (filters === '') {
        params = {
                    'start-index' : ''+current_start_index+'',
                    'max-results':  10,
                    'orderby':        'relevance',
                }
    } else if (filters === 'hd') {
        params = {
                    'start-index' : ''+current_start_index+'',
                    'max-results':  10,
                    'orderby':        'relevance',
                    'hd' : true
                }
    } else if (filters === '3d') {
        params = {
                    'start-index' : ''+current_start_index+'',
                    'max-results':  10,
                    'orderby':        'relevance',
                    '3d' : true
                }
    }
    try{
        youtube.feeds.related(vid,params,
            function( err, data ) {
            if( err ) {
                cb(err);
            } else  {
                cb(data);
            }
        });
    }catch(err){
        console.log('searchVideos err: '+err);
    }
}

// search in categories
yt.categories = function (query, page, filters,category, cb){
    videos_responses = new Array();
    if (page === 1){
        current_start_index = 1;
    } else {
        current_start_index = (page - 1) * 25 + 1;    
    }
    var params = {};
    if (query === ''){
        var orderby = 'published';
    } else {
        var orderby = 'relevance';
    }
    if (filters === '') {
        params = {
                    'q' : ''+query+'',
                    'start-index' : ''+current_start_index+'',
                    'max-results':  25,
                    'orderby':        ''+orderby+'',
                    'category': ''+category+''
                }
    } else if (filters === 'hd') {
        params = {
                    'q' : ''+query+'',
                    'start-index' : ''+current_start_index+'',
                    'max-results':  25,
                    'orderby':        ''+orderby+'',
                    'category': ''+category+'',
                    'hd' : true
                }
    } else if (filters === '3d') {
        params = {
                    'q' : ''+query+'',
                    'start-index' : ''+current_start_index+'',
                    'max-results':  25,
                    'orderby':        'relevance',
                    'category': ''+orderby+'',
                    '3d' : true
                }
    }
    try{
        youtube.feeds.category(category,params,
            function( err, data ) {
            if( err ) {
                cb(err);
            } else  {
                cb(data);
            }
        });
    }catch(err){
        console.log('searchVideos err: '+err);
    }
}



yt.getVideoInfos = function (video_link,num,total, cb){
	if (total === 1) {
	    videos_responses = new Array();
	}
    var video = {};
    video.num = num;
    video.total = total;
    video.link = video_link;
    video.cb = cb;
    try {
        ytdl.getInfo(video.link, video, function(err, video, info){
            if(err) {
                console.log(err);
            } else {
                video.id = info.video_id;
                video.title = info.title;
                video.views = info.view_count;
                video.thumb =  info.thumbnail_url;
                video.author = info.author;
                video.duration = info.length_seconds;
                if (info.use_cipher_signature === true){
                    try{
                        var request_options = 
                        {
                            host: 'm.youtube.com',
                            headers: {'user-agent': 'Mozilla/5.0 (iPhone; U; CPU iPhone OS 4_2_1 like Mac OS X; en-us) AppleWebKit/533.17.9 (KHTML, like Gecko) Version/5.0.2 Mobile/8G4 Safari/6533.18.5'},
                            path: '/watch?ajax=1&layout=mobile&tsp=1&utcoffset=120&v='+video.id
                        }
                        var req = http.request(request_options);
                        req.on('response',function(response) { 
                            var data = new Array(); 
                            var resolutions = {};
                            response.on("data", function(chunk) {
                                data.push(chunk);
                            });
                            response.on('end',function(){
                                var d = data.join('');
                                var datas = JSON.parse(d.replace(/\)\]\}\'/,''));
                                resolutions['480p'] = new Array();
                                try {
                                    resolutions['480p']['link'] = datas.content.video.fmt_stream_map[0].url;
                                } catch(err) {
                                    return;
                                }
                                resolutions['480p']['container'] = 'mp4';
                                video.resolutions = resolutions;
                                storeVideosInfos(video);
                            });
                        });
                        req.on('error', function(e) {
                            console.log("Got error: " + e.message);
                        });
                        req.end();
                    } catch(err){
                        console.log('youtube searchVideos err: '+err);
                    }
                } else {
                    var num=info.formats.length;
                    if ( parseInt(num) === 0) {
                            return;
                    }
                    var resolutions = {};
                    var res = [];
                    for(var i=0; i<num; i++) {
                        var resolution = info.formats[i].resolution;
                        var container = info.formats[i].container;
                        if ( in_array(resolution,res) === true || container == 'flv' || container == '3gp' ) {
                            continue;
                        }
                        res.push(resolution);
                        resolutions[resolution] = [];
                        var url = info.formats[i].url;
                            
                        resolutions[resolution]['link'] = url;
                        resolutions[resolution]['container'] = container;
                    }
                    video.resolutions = resolutions;
                    storeVideosInfos(video);
                }
            }
        });
        } catch(err) {
            console.log('getVideoInfos err: '+ err);
        }
}

//playlists
yt.searchPlaylists = function(user_search, page,cb){
    var videos_responses = new Array();
    if (page === 1){
        current_start_index = 1;
    } else {
        current_start_index = (page - 1) * 25 + 1;    
    }
    try {
        youtube.feeds.playlistSearch({
            q:              ''+user_search+'',
            'start-index' : ''+current_start_index+'',
            'max-results':  25,
            orderby:        'relevance'
            },
        function( err, data ) {
        if( err ) {
           cb(err);
        } else {
            cb(data);
        }
    });
    } catch(err) {
        console.log('searchPlaylists err: '+err);
    }   
}

//channels
yt.searchChannels = function(user_search, page,cb){
    var videos_responses = new Array();
    if (page === 1){
        current_start_index = 1;
    } else {
        current_start_index = (page - 1) * 25 + 1;    
    }
    try{
       videos_responses = new Array();
        var req=https.get('https://gdata.youtube.com/feeds/api/channels?q='+user_search+'&start-index='+current_start_index+'&v=2&alt=json&orderby=relevance');
        req.on('response',function(response) { 
            var data = new Array(); 
            response.on("data", function(chunk) {
                data.push(chunk)
            });
            response.on('end',function(){
                var datas = JSON.parse(data.join(''));
                cb(datas);
            });
        });
        req.on('error', function(e) {
            console.log("Got error: " + e.message);
        });
        req.end();
    } catch(err){
        console.log('youtube searchChannels err: '+err);
    }
}


yt.loadSongs = function(plid,length,index,cb){
    try{
        youtube.feeds.playlist(''+plid+'',{
                'start-index' : ''+index+'',
                'max-results':  25
            },
            function( err, data ) {
            if( err ) {
                cb( err );
            } else {
                cb(data, length, plid, 'youtube');
            }
        });
    } catch(err) {
        console.log('loadSongs err: '+err);
    }
}

yt.loadChannelSongs = function(url,page,cb){
    if (page === 1){
        current_start_index = 1;
    } else {
        current_start_index = (page - 1) * 25 + 1;    
    }
    try{
       videos_responses = new Array();
        var req=https.get(url+'&max-results=25&alt=jsonc&start-index='+current_start_index+'');
        req.on('response',function(response) { 
            var data = new Array(); 
            response.on("data", function(chunk) {
                data.push(chunk);
            });
            response.on('end',function(){
                var datas = JSON.parse(data.join(''));
                cb(datas);
            });
        });
        req.on('error', function(e) {
            console.log("Got error: " + e.message);
        });
        req.end();
    } catch(err){
        console.log('youtube searchChannels err: '+err);
    }
}

yt.standard = function(page,country,category,dateOrder,cb){
    if (page === 1){
        current_start_index = 1;
    } else {
        current_start_index = (page - 1) * 25 + 1;    
    }
    try{
        youtube.feeds.standard(''+country+'/'+category+'',{ 
                    'start-index' : ''+current_start_index+'',
                    'max-results':  25,
                    'time': dateOrder
            },
            function( err, datas ) {
            if( err ) {
                cb( err );
            } else {
                cb(datas);
            }
        });
    } catch(err) {
        console.log('standard feeds err: '+err);
    }
}

// store videos and return it in the right order...
function storeVideosInfos(video) {
    videos_responses[video.num]=video;
    if (videos_responses.length == video.total) {
        video.cb(videos_responses);
        videos_responses = new Array();
    }
}

// functions
function in_array (needle, haystack, argStrict) {
  var key = '',
    strict = !! argStrict;

  if (strict) {
    for (key in haystack) {
      if (haystack[key] === needle) {
        return true;
      }
    }
  } else {
    for (key in haystack) {
      if (haystack[key] == needle) {
        return true;
      }
    }
  }

  return false;
}

function swapHeadAndPosition(array, position) {
    var head  = array[0];
    var other = array[position % array.length];
    array[0] = other;
    array[position] = head;
    return array;
}

module.exports = yt;
