//load modules
var vidinfo = require('vidinfo')({format:true});
var https = require('https');
var http= require('http');
var request = require('request');
var ip = require('node-ip');

// module vars
var current_search_page=1;
var videos_responses = new Array();
var dmotion = {};

// search for videos

dmotion.searchVideos = function (user_search,page,filters,order,cb) {
    var totalResults = 0;
    try{
       videos_responses = new Array();
       var url = 'http://'+ip.address()+':8081/?link=https://api.dailymotion.com/videos?sort='+order+'&page='+page+'&limit=25&search='+user_search+'&fields=id&filters='+filters+'';
		request(''+url+'', function(err, res, body) {
			if (err) return cb(err);
			if (res.statusCode !== 200) {
			  return cb(new Error('Video not found'));
			}
			cb(JSON.parse(body));
		});
       
        //~ var req=http.get('http://'+ip.address()+':8081/?link=https://api.dailymotion.com/videos?sort='+order+'&page='+page+'&limit=25&search='+user_search+'&fields=id&filters='+filters+'');
        //~ req.on('response',function(response) { 
            //~ var data = new Array(); 
            //~ response.on("data", function(chunk) {
                //~ data.push(chunk)
            //~ });
            //~ response.on('end',function(){
                //~ var datas = JSON.parse(data.join(''));
                //~ cb(datas);
            //~ });
        //~ });
        //~ req.on('error', function(e) {
            //~ console.log("Got error: " + e.message);
        //~ });
        //~ req.end();
    } catch(err){
        console.log('dailymotion searchVideos err: '+err);
    }
}

// search/browse channels
dmotion.categories = function (user_search,page,filters,category,cb) {
    var totalResults = 0;
    try{
       videos_responses = new Array();
       var req;
        if (user_search === '') {
            req=https.get('https://api.dailymotion.com/videos?sort=recent&page='+page+'&limit=25&fields=id&filters='+filters+'&channel='+category);
        } else {
            req=https.get('https://api.dailymotion.com/videos?sort=relevance&page='+page+'&limit=25&search='+user_search+'&fields=id&filters='+filters+'&channel='+category);
        }
        req.on('response',function(response) { 
            var data = new Array(); 
            response.on("data", function(chunk) {
                data.push(chunk)
            });
            response.on('end',function(){
                var datas = JSON.parse(data.join(''));
                cb(datas);
            });
        });
        req.on('error', function(e) {
            console.log("Got error: " + e.message);
        });
        req.end();
    } catch(err){
        console.log('dailymotion searchVideos err: '+err);
    }
}

//search related
dmotion.searchRelated = function (vid,page,filters,cb) {
    var totalResults = 0;
    try{
       videos_responses = new Array();
        var req=https.get('https://api.dailymotion.com/video/'+vid+'/related?page='+page+'&limit=10&fields=id');
        req.on('response',function(response) { 
            var data = new Array(); 
            response.on("data", function(chunk) {
                data.push(chunk)
            });
            response.on('end',function(){
                var datas = JSON.parse(data.join(''));
                cb(datas);
            });
        });
        req.on('error', function(e) {
            console.log("Got error: " + e.message);
        });
        req.end();
    } catch(err){
        console.log('dailymotion searchVideos err: '+err);
    }
}

// get infos from video id
dmotion.getVideoInfos = function (id,num,total,cb) {
    vidinfo.dmo(id,function (obj) {
    var video = {};
    video.num=num;
    video.total=total;
    video.id = obj.id;
    video.link = obj.embed_url;
    video.title = obj.title;
    video.views = obj.views_total;
    video.thumb =  obj.thumbnail_medium_url;
    video.author = obj['user.screenname'];
    video.duration = obj.duration;
    video.cb = cb;
    
    if (video.link === undefined ) {
        return;
    }
    
    var url = 'http://'+ip.address()+':8081/?link='+video.link;
	request(url, function(err, res, body) {
		if (err) return cb(err);
		if (res.statusCode !== 200) {
		  return cb(new Error('Video not found'));
		}
		parseHtml(body.replace(/\\/g,''),video);
	});
    
			//var req=http.get(video.link);
			//req.on('response',function(response) { 
				//var body = ''; 
				//response.on("data", function(chunk) {
					//body+=chunk;
				//});
				//response.on('end',function(){
					//parseHtml(body.replace(/\\/g,''),video);
				//});
			//});
			//req.on('dailymotion getVideoInfo http error', function(e) {
				//return;
			//});
			//req.end();
    });
}

function parseHtml(data, video){
    resolutions_regex = ['stream_h264_hd1080_url','stream_h264_hd_url','stream_h264_hq_url','stream_h264_ld_url'];
    var resolutions_string = ['1080p','720p','480p','360p'];
    var resolutions = new Array([]);
    for(var v=0; v<resolutions_regex.length; v++) {
        try{
            var regex =  new RegExp(resolutions_regex[v]+'":(.*?),','i');
            var link=data.match(regex)[1].replace(/\"/g,'');
            var resolution = resolutions_string[v];
            resolutions[resolution] = [];
            resolutions[resolution]['link'] = link;
            resolutions[resolution]['container'] = 'mp4';
        } catch(err) {
            console.log(err);
        }
    }
    video.resolutions=resolutions;
    try {
        storeVideosInfos(video);
    } catch(err) {
        video.cb('dailymotion parsehtml err : ' + err);
    }
}

//search playlists

dmotion.searchPlaylists = function (user_search,page,cb){
    try{
        var url = 'http://'+ip.address()+':8081/?link=https://api.dailymotion.com/playlists?sort=relevance&page='+page+'&limit=25&search='+user_search+'&fields=id,description,owner.username,name,thumbnail_medium_url,videos_total';
		request(''+url+'', function(err, res, body) {
			if (err) return cb(err);
			if (res.statusCode !== 200) {
			  return cb(new Error('Video not found'));
			}
			cb(JSON.parse(body));
		});
        //req=https.get('https://api.dailymotion.com/playlists?sort=relevance&page='+page+'&limit=25&search='+user_search+'&fields=id,description,owner.username,name,thumbnail_medium_url,videos_total');
        //req.on('response',function(response) { 
            //var data = new Array(); 
            //response.on("data", function(chunk) {
                //data.push(chunk);
            //});
            //response.on('end', function() {
                //var datas = JSON.parse(data.join(''));
                //cb(datas);
            //});
        //});
        //req.on('error', function(e) {
            //console.log("Got error: " + e.message);
        //});
        //req.end();
    } catch(err){
        console.log('dailymotion searchPlaylists err: '+err);
    }
}

dmotion.loadSongs = function(plid,length,page,cb){
    try{
        req=https.get('https://api.dailymotion.com/playlist/'+plid+'/videos?page='+page+'&limit=25');
            req.on('response',function(response) { 
                var data = new Array(); 
                response.on("data", function(chunk) {
                    data.push(chunk)
                });
                response.on('end',function(){
                    var datas = JSON.parse(data.join(''));
                    cb(datas, length, plid, 'dailymotion');
                });
            });
        req.on('error', function(e) {
            console.log("Got error: " + e.message);
        });
        req.end();
    } catch(err) {
        console.log('dailymotion loadSongs err: '+err);
    }
}


// store videos and return it in the right order...
function storeVideosInfos(video) {
    videos_responses[video.num]=video;
    if (videos_responses.length == video.total) {
        video.cb(videos_responses);
        videos_responses= new Array();
    }
}


module.exports = dmotion;
